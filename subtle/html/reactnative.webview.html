<!DOCTYPE html>
<html>
<script src="https://cdn.jsdelivr.net/gh/yngfoxx/web-crypto-hooks/subtle/ecdsa.js"></script>
<script>
    
    var cert

    window.addEventListener('message', async msg => {
        const hasCrypto = 'subtle' in window.crypto
        if (!hasCrypto) {
            window.ReactNativeWebView.postMessage('not-supported')
            return;
        }

        const { action, payload } = JSON.parse(msg.data)
        switch (action) {
        case 'INIT':
            cert = await useECDSA()
            // Export public key in IEEE P1363 format
            const pub = cert.tmpKeys.publicKey
            const pbk = await crypto.subtle.exportKey('raw', pub).catch(alert)
            window.ReactNativeWebView.postMessage(JSON.stringify({
                publicKey: cert.buf2hex(new Uint8Array(pbk).buffer)
            }))
            break;

        case 'HASH':
            const hsh = cert.hash(payload.data)
            window.ReactNativeWebView.postMessage(JSON.stringify({
                hash: cert.buf2hex(hsh.buffer)
            }))
            break;

        case 'SIGN':
            const hash = new Uint8Array(cert.hex2buf(payload.data))
            const sig = await cert.sign(hash).catch(alert)
            window.ReactNativeWebView.postMessage(JSON.stringify({
                signature: cert.buf2hex(new Uint8Array(sig).buffer)
            }))
            break;

        case 'VERIFY':
            const isValid = await cert.verify(
                new Uint8Array(cert.hex2buf(payload.hash)), 
                new Uint8Array(cert.hex2buf(payload.signature))).catch(alert)
            alert(isValid ? 'VALID' : 'INVALID')
            break;
        }
    })
</script>
</html>